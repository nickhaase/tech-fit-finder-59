// Local GIF.js worker script to avoid CDN issues
// This file provides the worker implementation for gif.js locally

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).GIF=t()}(this,function(){"use strict";var e=function(e,t,n,r){function i(e){return o(e)||s(e)||c(e)||a()}function o(e){if(Array.isArray(e))return u(e)}function s(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function c(e,t){if(e){if("string"==typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function a(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}self.onmessage=function(e){var t=e.data||{},n=t.pixels,r=t.options;return self.postMessage(f(n,r))}};function f(e,t){var n=t||{},r=n.colors||256,i=n.dithering||!1,o=new NeuQuant(e,e.length,r);o.buildColormap();for(var s=o.getColormap(),c=new Array(e.length/4),u=0;u<e.length;u+=4){var a=o.lookupRGB(e[u],e[u+1],e[u+2]);c[u/4]=a}return{colorMap:s,indexedPixels:c}}var NeuQuant=function(){function e(e,t,n){this.pixels=e,this.samplefac=1,this.netsize=256,this.maxnetpos=255,this.netbiasshift=4,this.ncycles=100,this.intbiasshift=16,this.intbias=65536,this.gammashift=10,this.gamma=1024,this.betashift=10,this.beta=64,this.betagamma=1<<this.betashift-this.gammashift&this.gamma,this.initrad=32,this.radiusbiasshift=6,this.radiusbias=1<<this.radiusbiasshift,this.initradius=this.initrad*this.radiusbias,this.radiusdec=30,this.alphabiasshift=10,this.initalpha=1<<this.alphabiasshift,this.radbiasshift=8,this.radbias=1<<this.radbiasshift,this.alpharadbshift=this.alphabiasshift+this.radbiasshift,this.alpharadbias=1<<this.alpharadbshift,this.prime1=499,this.prime2=491,this.prime3=487,this.prime4=503,this.minpicturebytes=3*this.prime4,this.lengthcount=t,this.samplefac=n||1,this.network=new Array(this.netsize)}return e.prototype.buildColormap=function(){this.init(),this.learn(),this.unbiasnet(),this.inxbuild()},e.prototype.getColormap=function(){for(var e=new Array(768),t=0,n=0;t<this.netsize;t++)e[n++]=this.network[t][0],e[n++]=this.network[t][1],e[n++]=this.network[t][2];return e},e.prototype.lookupRGB=function(e,t,n){var r,i,o,s=1e3,c=-1;for(r=0;r<this.netsize;r++)(o=(i=this.network[r][0]-e)<0?-i:i)<s&&(s=o,c=r),(o=(i=this.network[r][1]-t)<0?-i:i)<s&&(s=o,c=r),(o=(i=this.network[r][2]-n)<0?-i:i)<s&&(s=o,c=r);return c},e.prototype.init=function(){for(var e=0;e<this.netsize;e++)this.network[e]=new Array(4),this.network[e][0]=this.network[e][1]=this.network[e][2]=255*(e<<this.netbiasshift+8)/this.netsize,this.bias=new Array(this.netsize),this.freq=new Array(this.netsize),this.radpower=new Array(32)},e.prototype.learn=function(){var e,t,n,r,i,o,s,c,u,a,f,h,l,d,p,g,m,v,b,y,w,_,x,k,A,C,F,S,O=this.lengthcount,j=this.samplefac,T=j;for(4!=j&&(T=30),r=0;r<this.radpower.length;r++)this.radpower[r]=Math.floor(this.initalpha*((this.radpower.length-1-r)**2/this.radpower.length**2));if(O<this.minpicturebytes)T=1;else if(O%this.prime1!=0)T=this.prime1;else if(O%this.prime2!=0)T=this.prime2;else if(O%this.prime3!=0)T=this.prime3;else T=this.prime4;for(e=0,t=0,n=0;n<O;)if(s=this.pixels[e]<<this.netbiasshift,c=this.pixels[e+1]<<this.netbiasshift,u=this.pixels[e+2]<<this.netbiasshift,a=this.contest(s,c,u),this.altersingle(t,a,s,c,u),0!=a&&this.alterneigh(a,t,s,c,u),0==(e+=T)%1E3){i=Math.floor(1e3*t/this.ncycles);for(f=this.initrad*((this.ncycles-t)/this.ncycles),f<1&&(f=1),h=f*f,l=(o=this.netsize>>3)>>1,d=o+l,p=o-l,p<-1&&(p=-1),g=0;g<=d;g++)this.radpower[g]=Math.floor(f*(h-(g=g>l?g-l:g)**2)/h);for(v=0;v<this.netsize;v++)this.bias[v]=Math.floor(this.initalpha*((this.netsize-1-v)/this.netsize)),this.freq[v]=Math.floor(this.intbias/this.netsize),this.network[v][3]=Math.floor(this.freq[v]/100);t++}for(A=0;A<this.netsize;A++)for(b=this.network[A],y=A+1;y<this.netsize;y++)(w=this.network[y])[0]<b[0]&&(_=w[0],w[0]=b[0],b[0]=_,x=w[1],w[1]=b[1],b[1]=x,k=w[2],w[2]=b[2],b[2]=k,C=w[3],w[3]=b[3],b[3]=C);for(F=0,S=0;S<this.netsize;S++)F+=this.freq[S],this.bias[S]=F},e.prototype.contest=function(e,t,n){var r,i,o,s,c,u,a=1e3,f=-1;for(r=0;r<this.netsize;r++)i=this.network[r],(o=Math.abs(i[0]-e))<a&&(a=o,f=r),(o+=Math.abs(i[1]-t))<a&&(a=o,f=r),(o+=Math.abs(i[2]-n))<a&&(a=o,f=r);return s=this.bias[f]-this.intbias,this.freq[f]-=s,this.bias[f]+=s>>this.intbiasshift,this.network[f][3]+=s>>this.intbiasshift,f},e.prototype.altersingle=function(e,t,n,r,i){var o=this.network[t],s=e/(this.ncycles-1),c=Math.floor(this.initalpha*s);o[0]+=(n-o[0])*c>>this.alphabiasshift,o[1]+=(r-o[1])*c>>this.alphabiasshift,o[2]+=(i-o[2])*c>>this.alphabiasshift},e.prototype.alterneigh=function(e,t,n,r,i){var o,s,c,u,a,f,h=Math.abs(e-t),l=t-h,d=t+h,p=t+1,g=t-1,m=1;for(p>=this.netsize&&(p-=this.netsize),g<0&&(g+=this.netsize);m<h||l<d;)if(o=this.radpower[m++],p<this.netsize){for(s=this.network[p++],c=o*(this.initalpha*(this.radpower.length-m)/this.radpower.length)>>this.alpharadbshift,s[0]+=(n-s[0])*c>>this.alphabiasshift,s[1]+=(r-s[1])*c>>this.alphabiasshift,s[2]+=(i-s[2])*c>>this.alphabiasshift,p>=this.netsize&&(p-=this.netsize),m>=h||l>=d;);break}if(g>=0){for(u=this.network[g--],a=o*(this.initalpha*(this.radpower.length-m)/this.radpower.length)>>this.alpharadbshift,u[0]+=(n-u[0])*a>>this.alphabiasshift,u[1]+=(r-u[1])*a>>this.alphabiasshift,u[2]+=(i-u[2])*a>>this.alphabiasshift,g<0&&(g+=this.netsize),m>=h||l>=d;);break}if(l<d){if(f=this.radpower[m++],l>=0){for(s=this.network[l],c=f*(this.initalpha*(this.radpower.length-m)/this.radpower.length)>>this.alpharadbshift,s[0]+=(n-s[0])*c>>this.alphabiasshift,s[1]+=(r-s[1])*c>>this.alphabiasshift,s[2]+=(i-s[2])*c>>this.alphabiasshift;);break}if(d<this.netsize){for(u=this.network[d],a=f*(this.initalpha*(this.radpower.length-m)/this.radpower.length)>>this.alpharadbshift,u[0]+=(n-u[0])*a>>this.alphabiasshift,u[1]+=(r-u[1])*a>>this.alphabiasshift,u[2]+=(i-u[2])*a>>this.alphabiasshift;);break}l--,d++}},e.prototype.unbiasnet=function(){for(var e=0;e<this.netsize;e++)this.network[e][0]>>=this.netbiasshift,this.network[e][1]>>=this.netbiasshift,this.network[e][2]>>=this.netbiasshift,this.network[e][3]=e},e.prototype.inxbuild=function(){var e,t,n,r,i,o,s=0;this.netindex=new Array(256);for(e=0;e<this.netsize;e++){for(r=(t=this.network[e])[0]>>this.netbiasshift-8,n=t[1]>>this.netbiasshift-8,i=t[2]>>this.netbiasshift-8,t[0]=r,t[1]=n,t[2]=i,t[3]=e,r<s&&(r=s),o=r+1;s<o;s++)this.netindex[s]=e-1;s=r,r>255&&(r=255)}for(o=s+1;s<256;s++)this.netindex[s]=e-1},e}();return e}());